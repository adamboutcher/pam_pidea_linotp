#
#    pam_pidea_linotp - LinOTP PAM module modified for Privacyidea
#    Copyright (C) 2010 - 2017 KeyIdentity GmbH
#    Copyright (C) 2026        Adam Boutcher - IPPP, Durham University
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#     E-mail: adam.j.boutcher@durham.ac.uk
#


This is the LinOTP pam module, which will send the username and
password - including otp - to the LinOTP-server to verify. Now with support
for PrivacyIDEA.

Thus you can login via OTP to every service that supports pam.

copy your /etc/pam.d/password-auth to something like /etc/pam.d/password-otp-auth and change the line:

auth        sufficient     pam_unix.so try_first_pass nullok

to

auth        required     pam_unix.so try_first_pass nullok
auth        sufficient   pam_pidea_linotp.so url=<url> realm=<realm>

Now you can use the

auth substack password-otp-auth

in every service you want to authenticate with Password and OTP.

Config options to be set in the pam configuration:
        url=http://localhost:5001/validate/simplecheck (LinOTP)
        url=http://localhost:5001/validate/check       (PrivacyIDEA)
        nosslhostnameverify
        nosslcertverify
        realm=<yourRealm>
        resConf=<specialResolverConfig>
        use_first_pass
        hide_otp_input
        debug (This will put the OTP in logs)



Disclaimer:

I don't really know write how to C, I have poorly modified this so it will work on EL9 with PrivacyIDEA, please open an issue/PR if you think of a saner way to make various checks and conversions.
Now also requires JANSSON (libjansson-dev or jansson-devel) for the PrivacyIDEA JSON support.

Have fun.
